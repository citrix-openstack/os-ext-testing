- job-template:
    name: 'dsvm-tempest-nova-network'
    node: '{node}'

    wrappers:
      - timeout:
          timeout: 185  # Timeout in *minutes*
          fail: true  # A job run that exceeds the timeout will cause a failure
      - timestamps

    builders:
      - net-info
      - shell: |
          #!/bin/bash -xe
          set +xe
          #########################
          sudo  sed -i '1i\192.168.33.2 localhost.localdomain' /etc/hosts
          cd /opt/git/openstack-infra/devstack-gate
          sudo /usr/bin/git remote update
          sudo /usr/bin/git checkout origin/master
          cd -
          
          set -xe

          if [ -e /home/jenkins/xenapi-os-testing ]
          then
              rm -rf /home/jenkins/xenapi-os-testing
          fi
          export ZUUL_URL=https://review.openstack.org/p

          
          #####################################################################################################
          /usr/bin/git clone https://github.com/openstack/xenapi-os-testing.git /home/jenkins/xenapi-os-testing
          if [ "$ZUUL_PROJECT" = "openstack/xenapi-os-testing" ]
          then
              cd /home/jenkins/xenapi-os-testing
              /usr/bin/git fetch $ZUUL_URL/openstack/xenapi-os-testing $ZUUL_REF
              /usr/bin/git checkout FETCH_HEAD
              cd -
          fi
          #####################################################################################################
          # disable n-novnc
          sudo sed -i '/function pre_test_hook/a sudo sed -i -e "s/n-novnc, //g" /opt/stack/new/devstack-gate/features.yaml' /home/jenkins/xenapi-os-testing/run_tests.sh
            
          sudo sed -i 's/DEVSTACK_GATE_BRANCH="master"/DEVSTACK_GATE_BRANCH="rebaseToResolveTempestRunError"/' /home/jenkins/xenapi-os-testing/run_tests.sh

          PYTHONUNBUFFERED=true DEVSTACK_GATE_TEMPEST=1 DEVSTACK_GATE_TEMPEST_FULL=1 \
          DEVSTACK_GATE_VIRT_DRIVER=xenapi DEVSTACK_GATE_TIMEOUT=180 APPLIANCE_NAME=devstack \
          /home/jenkins/xenapi-os-testing/run_tests.sh 2>&1  | tee /home/jenkins/run_tests.log

          if grep -q "Failed" ~/result.txt
          then
              exit 137
          fi
         
      - link-logs  # In macros.yaml from os-ext-testing

    publishers:
      #- osci-swift-upload-logs:
      - osci-swift-upload-logs-with-console:
          upload_source: 'logs logs/run_tests.log'

- job-template:
    name: 'dsvm-tempest-neutron-network'
    #name: 'check-citrix-xenserver-neutron'
    node: '{node}'

    wrappers:
      - timeout:
          timeout: 230  # Timeout in *minutes*
          fail: true  # A job run that exceeds the timeout will cause a failure
      - timestamps

    builders:
      - net-info
      - shell: |
          #!/bin/bash -xe
          set +xe
          sudo  sed -i '1i\192.168.33.2 localhost.localdomain' /etc/hosts
          cd /opt/git/openstack-infra/devstack-gate
          sudo /usr/bin/git remote update
          sudo /usr/bin/git checkout origin/master
          cd -
          
          set -xe

          if [ -e /home/jenkins/xenapi-os-testing ]
          then
              rm -rf /home/jenkins/xenapi-os-testing
          fi
          export ZUUL_URL=https://review.openstack.org/p
          export ZUUL_PROJ_CHANGE=$(echo $ZUUL_CHANGES | tr '^' '\n' | grep $ZUUL_CHANGE)
          export ZUUL_REF=$(echo $ZUUL_PROJ_CHANGE | cut -d: -f3)
          /usr/bin/git clone https://github.com/openstack/xenapi-os-testing.git /home/jenkins/xenapi-os-testing
          if [ "$ZUUL_PROJECT" = "openstack/xenapi-os-testing" ]
          then
              cd /home/jenkins/xenapi-os-testing
              /usr/bin/git fetch https://review.openstack.org/openstack/xenapi-os-testing $ZUUL_REF
              /usr/bin/git checkout FETCH_HEAD
              cd -
          fi
 
          RUN_SHELL=/home/jenkins/xenapi-os-testing/run_tests.sh


          sudo sed -i 's/DEVSTACK_GATE_BRANCH="master"/DEVSTACK_GATE_BRANCH="rebaseToResolveTempestRunError"/' /home/jenkins/xenapi-os-testing/run_tests.sh
          # disable n-novnc
          sudo sed -i '/function pre_test_hook/a sudo sed -i -e "s/n-novnc, //g" /opt/stack/new/devstack-gate/features.yaml' /home/jenkins/xenapi-os-testing/run_tests.sh
          
          
          PYTHONUNBUFFERED=true DEVSTACK_GATE_TEMPEST=1 DEVSTACK_GATE_TEMPEST_FULL=1 \
          DEVSTACK_GATE_VIRT_DRIVER=xenapi BUILD_TIMEOUT=24000000 APPLIANCE_NAME=devstack \
          DEVSTACK_GATE_NEUTRON=1 \
          /home/jenkins/xenapi-os-testing/run_tests.sh 2>&1  | tee /home/jenkins/run_tests.log

          if grep -q "Failed" ~/result.txt
          then
              exit 137
          fi
         
      - link-logs  # In macros.yaml from os-ext-testing

    publishers:
      #- osci-swift-upload-logs:
      - osci-swift-upload-logs-with-console:
          upload_source: 'logs logs/run_tests.log'

- job-template:
    name: 'check-fuel-plugin-xenserver-{xenserver_version}'
    node: '{node}'

    wrappers:
      - timeout:
          timeout: 185  # Timeout in *minutes*
          fail: true  # A job run that exceeds the timeout will cause a failure
      - timestamps

    builders:
      #- net-info
      - shell: |
          #!/bin/bash -xe
          env
          
          #If disable ceilometer by force
          export FORCE_DISABLE_CEILOMETER=""
          export ZUUL_CHANGES=${ZUUL_CHANGES:-""}

          echo "Testing fuel xenserver plugin"
          export FUEL_TEST_LOG_DIR=$WORKSPACE/logs
          LOG=$WORKSPACE/test.log
          rm -rf $WORKSPACE
          mkdir -p $WORKSPACE
          mkdir -p $FUEL_TEST_LOG_DIR
          cd $WORKSPACE
          git clone https://github.com/citrix-openstack/qa -b master
          cd qa/fuel_test
          cp localrc.default localrc
          export XS_HOST=$(hostname | cut -d'-' -f2).xenrt.citrite.net
          export FM_MNT="10.71.77.230:/data/exports"
          export FM_PWD="r00tme"
          export ZUUL_URL="http://10.71.212.50/p"
          export IXE_NFS="10.62.16.21:/openstack"
          export IXE_ISO="ipxe_20160809.iso"
          export FUEL_TEST_SUCCESS=$WORKSPACE/fuel_test_sucess
          rm -f $FUEL_TEST_SUCCESS
 
          ./fuel_test.sh 2>&1| tee -a $LOG
          
          if [ ! -f $FUEL_TEST_SUCCESS ]; then
              exit 137
          fi

    publishers:
      - osci-swift-upload-logs-with-console-plugin:
          upload_source: 'test.log logs'

    publishers:
      - osci-swift-upload-logs-with-console-plugin:
          upload_source: 'test.log logs'
